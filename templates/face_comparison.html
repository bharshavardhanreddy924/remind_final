{% extends "base.html" %}

{% block title %}Face Comparison{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('user_dashboard') }}" class="btn btn-sm btn-outline-secondary me-3">
                    <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
                </a>
                <h1 class="mb-0">Face Comparison</h1>
            </div>
            <p class="text-muted mt-2">
                Upload a photo to compare with your reference faces
            </p>
        </div>
    </div>

    <!-- Toast container for notifications -->
    <div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

    <!-- Network status indicator -->
    <div id="network-status" class="alert alert-warning d-none mb-3">
        <i class="fas fa-wifi-slash me-2"></i>
        <span id="network-status-message">You are currently offline. Some features may not work.</span>
    </div>

    {% if reference_faces_exist is defined and not reference_faces_exist %}
    <div class="alert alert-warning" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>No reference faces found!</strong> Please <a href="{{ url_for('add_reference_face') }}" class="alert-link">add reference faces</a> first to make comparison work.
    </div>
    {% endif %}

    {% if error_message %}
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        {{ error_message }}
    </div>
    {% endif %}

    {% if success_message %}
    <div class="alert alert-success" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        {{ success_message }}
    </div>
    {% endif %}

    <div class="row">
        <!-- Upload Section -->
        <div class="col-lg-5 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-upload me-2"></i> Upload Photo</h5>
                </div>
                <div class="card-body">
                    <form action="{{ url_for('face_comparison') }}" method="POST" enctype="multipart/form-data" id="compare-form">
                        <div class="mb-3">
                            <label for="photo" class="form-label">Select a photo to compare</label>
                            <input type="file" class="form-control" id="photo" name="photo" accept="image/*" required>
                            <div class="form-text">Upload a clear photo of a person's face</div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="btn-group w-100">
                                <button type="button" id="camera-option" class="btn btn-outline-secondary">
                                    <i class="fas fa-camera me-1"></i> Use Camera
                                </button>
                                <button type="button" id="gallery-option" class="btn btn-outline-secondary">
                                    <i class="fas fa-images me-1"></i> Gallery
                                </button>
                            </div>
                        </div>
                        
                        <div id="preview-container" class="text-center mb-3 d-none">
                            <p>Preview:</p>
                            <img id="preview-image" class="img-fluid rounded" style="max-height: 300px;">
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary" id="submit-button">
                                <i class="fas fa-search me-2"></i> Compare Faces
                            </button>
                        </div>
                    </form>
                    
                    <div id="loading" class="text-center my-3 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Processing image...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="col-lg-7 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-list-check me-2"></i> Comparison Results</h5>
                </div>
                <div class="card-body">
                    {% if comparison_results %}
                    <div class="row mb-4">
                        <div class="col-12 text-center">
                            <h6 class="mb-3">Uploaded Photo:</h6>
                            <img src="{{ url_for('static', filename=comparison_results.uploaded_image) }}" class="img-fluid rounded" style="max-height: 250px;">
                        </div>
                    </div>
                    
                    <h6 class="border-bottom pb-2 mb-3">Faces Detected: {{ comparison_results.faces|length }}</h6>
                    
                    {% for face in comparison_results.faces %}
                    <div class="face-result mb-4">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    Face #{{ loop.index }}
                                    {% if face.matches|length > 0 %}
                                    <span class="badge bg-success ms-2">Matches Found</span>
                                    {% else %}
                                    <span class="badge bg-secondary ms-2">No Matches</span>
                                    {% endif %}
                                </h6>
                            </div>
                            <div class="card-body">
                                {% if face.matches|length > 0 %}
                                <div class="row g-3">
                                    {% for match in face.matches %}
                                    <div class="col-md-6">
                                        <div class="card h-100">
                                            <div class="card-header d-flex justify-content-between align-items-center p-2">
                                                <h6 class="mb-0 text-truncate">{{ match.name }}</h6>
                                                <span class="badge bg-primary">{{ "%.1f"|format(match.confidence) }}%</span>
                                            </div>
                                            <div class="card-body p-2 text-center">
                                                <img src="{{ url_for('static', filename=match.image_path) }}" 
                                                     class="img-fluid match-image" 
                                                     data-fallback-src="{{ url_for('static', filename='images/placeholder.jpg') }}"
                                                     style="max-height: 150px;">
                                                {% if match.relation %}
                                                <p class="small text-muted mt-2 mb-0">Relationship: {{ match.relation }}</p>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="text-center py-3">
                                    <i class="fas fa-user-question fa-3x text-muted mb-3"></i>
                                    <p>No matches found for this face.</p>
                                    <p class="text-muted small">
                                        Try adding more reference faces or using a clearer photo.
                                    </p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-exchange-alt fa-4x text-muted mb-3"></i>
                        <h5>No Comparison Results</h5>
                        <p class="text-muted">Upload a photo to compare with reference faces.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="card shadow-sm mt-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> About Face Comparison</h5>
        </div>
        <div class="card-body">
            <p>Face Comparison allows you to upload a photo and identify people by comparing with reference faces.</p>
            <p><strong>How it works:</strong></p>
            <ol>
                <li>Upload a photo with one or more faces</li>
                <li>The system detects all faces in the photo</li>
                <li>Each detected face is compared against your reference faces</li>
                <li>Matching faces are displayed with a confidence percentage</li>
            </ol>
            <p><strong>Tips for best results:</strong></p>
            <ul>
                <li>Use clear, well-lit photos</li>
                <li>Ensure faces are clearly visible and not obscured</li>
                <li>For best results, faces should be facing the camera</li>
                <li>Add multiple reference photos of the same person from different angles</li>
            </ul>
            <div class="alert alert-secondary mt-3">
                <i class="fas fa-shield-alt me-2"></i>
                <strong>Privacy Note:</strong> Photos are processed locally on the server and are not shared with third parties. 
                Your uploaded photos are stored in your account for reference only.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Photo preview
        const photoInput = document.getElementById('photo');
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        const compareForm = document.getElementById('compare-form');
        const submitButton = document.getElementById('submit-button');
        const loadingIndicator = document.getElementById('loading');
        const cameraButton = document.getElementById('camera-option');
        const galleryButton = document.getElementById('gallery-option');
        const networkStatus = document.getElementById('network-status');
        const networkStatusMessage = document.getElementById('network-status-message');
        
        // Handle image loading errors
        document.querySelectorAll('.match-image').forEach(img => {
            img.addEventListener('error', function() {
                const fallbackSrc = this.getAttribute('data-fallback-src');
                if (fallbackSrc) {
                    this.src = fallbackSrc;
                }
            });
        });
        
        // Photo input change handler
        if (photoInput) {
            photoInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file && file.type.match('image.*')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        previewContainer.classList.remove('d-none');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Camera button click handler
        if (cameraButton) {
            cameraButton.addEventListener('click', function() {
                if (photoInput) {
                    photoInput.setAttribute('capture', 'user');
                    photoInput.click();
                }
            });
        }
        
        // Gallery button click handler
        if (galleryButton) {
            galleryButton.addEventListener('click', function() {
                if (photoInput) {
                    photoInput.removeAttribute('capture');
                    photoInput.click();
                }
            });
        }
        
        // Form submission handler with loading indicator and network error handling
        if (compareForm) {
            compareForm.addEventListener('submit', function(e) {
                // Check if a file is selected
                if (photoInput && photoInput.files.length === 0) {
                    e.preventDefault();
                    alert('Please select a photo to compare.');
                    return;
                }
                
                // Check if network is available
                if (!navigator.onLine) {
                    e.preventDefault();
                    showToast('Network error. Please check your connection and try again.', 'error');
                    return;
                }
                
                // Show loading indicator
                if (submitButton && loadingIndicator) {
                    submitButton.disabled = true;
                    loadingIndicator.classList.remove('d-none');
                }
                
                // Set a timeout to handle stalled requests
                const timeoutId = setTimeout(() => {
                    if (submitButton && loadingIndicator) {
                        submitButton.disabled = false;
                        loadingIndicator.classList.add('d-none');
                        showToast('Request timed out. Please try again.', 'error');
                    }
                }, 30000); // 30 second timeout
                
                // Add event listener for the "offline" event
                window.addEventListener('offline', function offlineHandler() {
                    clearTimeout(timeoutId);
                    submitButton.disabled = false;
                    loadingIndicator.classList.add('d-none');
                    showToast('Network connection lost. Please check your connection and try again.', 'error');
                    window.removeEventListener('offline', offlineHandler);
                }, { once: true });
            });
        }
        
        // Function to speak results if available
        function speakResults() {
            if ('speechSynthesis' in window) {
                const results = document.querySelectorAll('.face-result');
                if (results.length > 0) {
                    let speech = `Found ${results.length} faces in the photo. `;
                    
                    results.forEach((result, index) => {
                        const matchBadge = result.querySelector('.badge');
                        const isMatch = matchBadge && matchBadge.classList.contains('bg-success');
                        
                        if (isMatch) {
                            const matches = result.querySelectorAll('.card-header .text-truncate');
                            const confidences = result.querySelectorAll('.card-header .badge');
                            
                            speech += `Face ${index + 1} matches with `;
                            
                            if (matches.length > 0) {
                                speech += matches[0].textContent;
                                if (confidences.length > 0) {
                                    speech += ` with ${confidences[0].textContent} confidence. `;
                                }
                            }
                        } else {
                            speech += `Face ${index + 1} has no matches. `;
                        }
                    });
                    
                    const utterance = new SpeechSynthesisUtterance(speech);
                    speechSynthesis.speak(utterance);
                }
            }
        }
        
        // Add speak button if there are results
        if (document.querySelector('.face-result')) {
            const resultsHeader = document.querySelector('.card-header:contains("Comparison Results")');
            if (resultsHeader) {
                const speakButton = document.createElement('button');
                speakButton.className = 'btn btn-sm btn-outline-light ms-2';
                speakButton.innerHTML = '<i class="fas fa-volume-up me-1"></i> Speak Results';
                speakButton.addEventListener('click', speakResults);
                resultsHeader.appendChild(speakButton);
            }
        }
        
        // Function to show toast notifications
        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1050';
                document.body.appendChild(toastContainer);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Initialize toast with Bootstrap
            if (typeof bootstrap !== 'undefined') {
                const bsToast = new bootstrap.Toast(toast, {
                    animation: true,
                    autohide: true,
                    delay: 5000
                });
                bsToast.show();
            } else {
                // Fallback if Bootstrap JS is not loaded
                toast.style.display = 'block';
                setTimeout(() => {
                    toast.remove();
                }, 5000);
            }
        }
        
        // Function to update network status UI
        function updateNetworkStatus() {
            if (navigator.onLine) {
                networkStatus.classList.add('d-none');
                networkStatusMessage.textContent = 'You are back online!';
            } else {
                networkStatus.classList.remove('d-none');
                networkStatusMessage.textContent = 'You are currently offline. Some features may not work.';
            }
        }
        
        // Check network status on page load
        updateNetworkStatus();
        
        // Listen for online/offline events
        window.addEventListener('online', () => {
            updateNetworkStatus();
            showToast('You are back online!', 'success');
        });
        
        window.addEventListener('offline', () => {
            updateNetworkStatus();
            showToast('You are now offline. Some features may not work.', 'warning');
        });
        
        // Add retry button for failed image loads
        document.querySelectorAll('.match-image').forEach(img => {
            const container = img.closest('.card-body');
            if (container) {
                const retryButton = document.createElement('button');
                retryButton.className = 'btn btn-sm btn-outline-secondary mt-2 d-none retry-image';
                retryButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Retry loading image';
                retryButton.addEventListener('click', function() {
                    const originalSrc = img.getAttribute('src');
                    img.src = ''; // Clear src first
                    setTimeout(() => {
                        img.src = originalSrc; // Try loading again
                    }, 100);
                });
                container.appendChild(retryButton);
                
                img.addEventListener('error', function() {
                    retryButton.classList.remove('d-none');
                });
                
                img.addEventListener('load', function() {
                    retryButton.classList.add('d-none');
                });
            }
        });
    });
</script>
{% endblock %} 